<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone=no">
    <title>学校公告</title>
    <script src="../js/template.js"></script>
    <script src="../js/jquery-3.1.1.min.js"></script>
    <!--微信 钉钉 sdk-->
    <script type="text/javascript" src="//res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>

    <style>
        /*清楚默认样式*/
        html, body, div, ul, li, h1, h2, h3, h4, h5, h6, p, dl, dt, dd, ol, form, input, textarea, th, td, select {
            margin: 0;
            padding: 0;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            min-height: 100%;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: normal;
        }

        ul, ol {
            list-style: none;
        }

        img {
            border: none;
            vertical-align: middle;
        }

        a {
            text-decoration: none;
            color: #232323;
        }

        #announcementShareCon {
            padding: 0 15px;
        }

        #announcementShareCon a.text-link{
            color: #005de6;
            text-decoration: underline;
        }
        #announcementShareCon .title {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-size: 18px;
            color: #333;
            height: 45px;
            line-height: 50px;
        }

        #announcementShareCon .date {
            font-size: 15px;
            color: #999;
            height: 30px;
            border-bottom: 1px solid #eef1f6;
        }

        #announcementShareCon .content {
            padding-top: 20px;
            padding-bottom: 20px;
            font-size: 15px;
            color: #666;
            word-wrap: break-word;
        }

        #announcementShareCon .content div {
            max-width: 100%;
        }

        #announcementShareCon .content span {
            white-space: normal !important;
        }

        #announcementShareCon .delete {
            padding-top: 50px;
            text-align: center;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #FFFFFF;
        }
    </style>
</head>
<body>
<div id="announcementShareCon">
    <div class="msg">
    </div>

    <div class="delete">
        该公告已被删除
    </div>
</div>
</body>
<script id="list" type="text/html">

    <div class="title">
        {{title}}
    </div>
    <div class="date">
        {{date}}
    </div>
    <div class="content">
        {{#formatContent(content)}}
    </div>

</script>
<script>
    // //微信初始化配置
    function wxShareInit(obj,opt) {
        // 微信配置
        wx.config({
            debug: false,
            appId: obj.WX_config_appId,
            timestamp: obj.WX_config_timestamp,
            nonceStr: obj.WX_config_nonceStr,
            signature: obj.WX_config_signature,
            jsApiList: ["onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareWeibo", "onMenuShareQZone"]
        });
        wx.ready(function () {
            // 通过微信菜单分享
            onMenuShare({
                title: '学校公告', // 分享标题
                desc: opt.title, // 分享描述
                link: location.href, // 分享链接
                imgUrl: location.protocol + "//" + location.host + '/weixin/teacher/static/share/imgs/share.png', // 分享图标
                type: 'link', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function (shareType) {
                    console.log('success')
                    // doShareNum({
                    //     uid: searchObj.id,
                    //     type: shareType
                    // })
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            })
        });

        wx.error(function (res) {
            // alert(JSON.stringify(res));
            //上线注销
            alert("微信接口不稳定，暂时不支持部分功能。");
        });
    }

    ////通过微信菜单分享
    function onMenuShare(opt) {
        // 1 获取“分享到朋友圈”按钮点击状态及自定义分享内容接口
        // 2 获取“分享给朋友”按钮点击状态及自定义分享内容接口
        // 3 获取“分享到QQ”按钮点击状态及自定义分享内容接口
        // 4  获取“分享到QQ空间”按钮点击状态及自定义分享内容接口
        // 5  获取“分享到腾讯微博”按钮点击状态及自定义分享内容接口

        // 分享给朋友
        wx.onMenuShareAppMessage({
            title: opt.title, // 分享标题
            desc: opt.desc, // 分享描述
            link: opt.link + '&type=' + 2, // 分享链接
            imgUrl: opt.imgUrl, // 分享图标
            type: opt.type, // 分享类型,music、video或link，不填默认为link
            dataUrl: opt.dataUrl, // 如果type是music或video，则要提供数据链接，默认为空
            success: function () {
                opt.success(2)
            }, // 用户确认分享后执行的回调函数
            cancel: opt.cancel // 用户取消分享后执行的回调函数
        });
        // 分享到朋友圈
        wx.onMenuShareTimeline({
            title: opt.title, // 分享标题
            link: opt.link + '&type=' + 1, // 分享链接
            imgUrl: opt.imgUrl, // 分享图标
            success: function () {
                opt.success(1)
            }, // 用户确认分享后执行的回调函数
            cancel: opt.cancel // 用户取消分享后执行的回调函数
        });
        // 分享到QQ
        wx.onMenuShareQQ({
            title: opt.title, // 分享标题
            desc: opt.desc, // 分享描述
            link: opt.link  + '&type=' + 3, // 分享链接
            imgUrl: opt.imgUrl, // 分享图标
            success: function () {
                opt.success(3)
            }, // 用户确认分享后执行的回调函数
            cancel: opt.cancel // 用户取消分享后执行的回调函数
        });
        // 分享到QQ空间
        wx.onMenuShareQZone({
            title: opt.title, // 分享标题
            desc: opt.desc, // 分享描述
            link: opt.link + '&type=' + 4, // 分享链接
            imgUrl: opt.imgUrl, // 分享图标
            success: function () {
                opt.success(4)
            }, // 用户确认分享后执行的回调函数
            cancel: opt.cancel // 用户取消分享后执行的回调函数
        });
        // 分享到腾讯微博
        wx.onMenuShareWeibo({
            title: opt.title, // 分享标题
            desc: opt.desc, // 分享描述
            link: opt.link + '&type=' + 5, // 分享链接
            imgUrl: opt.imgUrl, // 分享图标
            success: function () {
                opt.success(5)
            }, // 用户确认分享后执行的回调函数
            cancel: opt.cancel // 用户取消分享后执行的回调函数
        });
    }

    function getData() {
        var args = getSearchObj();

        $.ajax({
            type: 'GET',
            url: '/weixin/teacher/t-show/PublicInfoProcess.ashx',
            data: {
                id: args.id,
                url:location.href
            },
            success: function (res) {
                var obj = {};
                if (res) {
                    obj = JSON.parse(res)
                }

                if (obj.data.publicInfo.id == "00000000-0000-0000-0000-000000000000") {
                    $('#announcementShareCon .msg').hide();
                    $('#announcementShareCon .delete').show();
                } else {
                    announcementShare_wxConfig = obj.data.wxConfig;
                    wxShareInit(announcementShare_wxConfig,obj.data.publicInfo);

                    // 渲染
                    var html = template('list', obj.data.publicInfo);

                    $('#announcementShareCon .msg').html(html);

                }

            }
        })
    }

    getData()
    // 图片预览
    $('#announcementShareCon .msg').on('click', 'img', function () {

        var preClickTime = 0;
        var curClickTime = new Date().getTime();
        if (curClickTime - preClickTime < 500) { //保证在500ms内不会重复打开两次预览(用户快速双击时), 造成不好的体验;
            return;
        }
        preClickTime = curClickTime;

        var current = tool.getAbsUrl($(this).attr('src')),
            listImgFile = $('#announcementShareCon .msg .content').find('img');
            urls = [];
        for(var i=0;i<listImgFile.length;i++){
            urls.push(tool.getAbsUrl(listImgFile[i].getAttribute('src')))
        }

        if ($(this)[0].nodeName.toLowerCase() === 'img') {
            wx.previewImage({
                current: current, // 当前显示图片的http链接
                urls: urls // 需要预览的图片http链接列表
            });
        }
    });



    /**************************
     *******辅助方法**********
     **********************/
    template.helper('formatContent', function (con) {
        var con = tool.richTextToHtml(tool.parseDom(con));
        return con
    });
    // 将url查询部分字符串转化为json对象格式并返回
    function getSearchObj() {
        var qs = location.search.length > 0 ? location.search.substr(1) : '',
            args = {},
            items = qs.length > 0 ? qs.split('&') : [],
            item = null, name = null, value = null, i = 0, len = items.length;

        for (i = 0; i < len; i++) {
            item = items[i].split('=');
            name = decodeURIComponent(item[0]);
            value = decodeURIComponent(item[1]);

            if (name.length) {
                args[name] = value;
            }
        }

        return args;
    }

    var tool = {};
    tool.getAbsUrl = function (url) {
        var rdeuce = /\/\w+\/\.\./,
            parentUrl = location.protocol + '//' + location.host;
        if (!isAbsUrl(url)) {
            url = joinPath(parentUrl, url)
        }
        if(/^\/\//.test(url)){
            url = location.protocol + url;
        }
        return url;

        function joinPath(a, b) {
            //末尾
            if (a.charAt(a.length - 1) !== "/") {
                a += "/"
            }

            //相对于兄弟路径
            if (b.slice(0, 2) === "./") {
                return a + b.slice(2)
            }
            if (b.slice(0, 1) === "/") {
                return a + b.slice(1)
            }

            //相对于父路径
            if (b.slice(0, 2) === "..") {
                a += b // example: d/a/../b/c
                while (rdeuce.test(a)) {
                    a = a.replace(rdeuce, "")
                }
                return a
            }
            return a + b
        }

        function isAbsUrl(path) {
            return /^(?:[a-z]+:)?\/\//i.test(String(path))
        }
    };

    tool.parseDom = function (arg) {
        var objE = document.createElement('div');
        objE.innerHTML = arg;
        return objE.innerText;
    };

    var _reg = /<br\/?>$/;
    var _map = {
        r: /\<|\>|\&|\r|\n|\s|\'|\"/g,
        '<': '&lt;',
        '>': '&gt;',
        '&': '&amp;',
        ' ': '&nbsp;',
        '"': '&quot;',
        "'": '&#39;',
        '\n': '<br/>',
        '\r': ''
    };
    tool.escape = function (_content) {
        _content = tool.encode(_map, _content)
        return _content.replace(_reg, '<br/>');
    };
    tool.encode = function (_map, _content) {
        _content = '' + _content
        if (!_map || !_content) {
            return _content || ''
        }
        return _content.replace(_map.r, function ($1) {
            var _result = _map[!_map.i ? $1.toLowerCase() : $1]
            return _result != null ? _result : $1
        });
    };
    // 从字符串中把链接识别出来
    tool.replaceUrlToLink = function (str) {
        // 在字符串中匹配URL的正则：
        var reg = /((http|ftp|https):\/\/)?((([a-zA-Z0-9\._-]+\.[a-zA-Z]{1,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))[\/=\?%\-&_~`@[\]:+!]*([^<>\"\'\s\u4e00-\u9fa5])*)/gi;

        // 判断url是否以[http://, https://, ftp://]开头的正则
        var regHeader = /^(http|ftp|https):\/\//

        var result,
            start = 0,
            end = 0,
            href = "", //用于保存将要写在a标签href属性中的链接；
            substr = "",
            newStr = "";

        // 通过正则对象的exec方法,从传入的字符串中遂一匹配出所有合法URL;
        while ((result = reg.exec(str)) != null) {
            end = reg.lastIndex;
            substr = str.substring(start, end);
            start = end;

            // 如果查找出的url不是以[http://, https://, ftp://]开头,则默认为http://开头;
            href = regHeader.test(result[0]) ? result[0] : ('http://' + result[0]);

            // 将提取到的字符串片段替换
            substr = substr.replace(result[0], '<a target="_blank" class="text-link" href="' + href + '">' + result[0] + '</a>')

            // 组装新的字串
            newStr += substr;
        }
        // 加上最后没有匹配到的字串
        newStr += str.substring(start);

        return newStr;
    }
    // 从普通文本中把链接识别出来, 先把文本中相应特殊元素转义,在进行url识别;
    // 转义的作用是，比如文本中可能会有 <script src="">
    // 这样就可以把这些变成普通文本进行展示;
    // 参数escape表示是否需要先转义（主要看传进来的str是否已经转义过了）
    tool.textToHtml = function (str, escape) {
        var text = escape ? tool.escape(str) : str.replace(/\n/g, '<br/>'),
            html;

        text = text.replace(/&lt;/gi, '<!@#$%0%$#@!>');
        text = text.replace(/&gt;/gi, '<!@#$%1%$#@!>');
        text = text.replace(/&nbsp;/gi, '<!@#$%2%$#@!>');
        text = text.replace(/&quot;/gi, '<!@#$%3%$#@!>');
        text = text.replace(/&#39;/gi, '<!@#$%4%$#@!>');
        text = text.replace(/<br\/>/gi, '<!@#$%5%$#@!>');

        html = tool.replaceUrlToLink(text)

        html = html.replace(/<!@#\$%0%\$#@!>/gi, '&lt;');
        html = html.replace(/<!@#\$%1%\$#@!>/gi, '&gt;');
        html = html.replace(/<!@#\$%2%\$#@!>/gi, '&nbsp;');
        html = html.replace(/<!@#\$%3%\$#@!>/gi, '&quot;');
        html = html.replace(/<!@#\$%4%\$#@!>/gi, '&#39;');
        html = html.replace(/<!@#\$%5%\$#@!>/gi, '<br/>');

        return html
    };
    // 从富文本中把链接识别出来,
    // 参数escape表示是否需要先转义
    tool.richTextToHtml = function (str, escape) {
        var regRule = '<[\s]*?a.*?>.*?<\/[\s]*?a[\s]*?>'
            + '|'
            + '<[\s]*?img.*?>'
            + '|'
            + '<div class="voice" .*?></div>';
        var reg = new RegExp(regRule, 'ig');
        var result,
            start = 0,
            end = 0,
            substr = "",
            newStr = "",
            str1 = "",
            str2 = "";

        // 通过正则对象的exec方法,从传入的字符串中遂一匹配出所有合法URL;
        while ((result = reg.exec(str)) != null) {
            end = reg.lastIndex;
            substr = str.substring(start, end);
            start = end;

            var len = result[0].length;

            str1 = substr.slice(0, 0 - len);
            str2 = substr.slice(0 - len);

            // 组装新的字串
            newStr += (tool.textToHtml(str1, escape) + str2);
        }
        // 加上最后没有匹配到的字串
        substr = str.substring(start);

        newStr += tool.textToHtml(substr, escape);

        return newStr;
    }
</script>
</html>